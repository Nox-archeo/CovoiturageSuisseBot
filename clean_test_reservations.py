#!/usr/bin/env python3
"""
Script pour supprimer les rÃ©servations de test
"""
import os
import sys
from dotenv import load_dotenv

# Charger les variables d'environnement
load_dotenv()

# Ajouter le rÃ©pertoire racine au path pour les imports
sys.path.insert(0, '/Users/margaux/CovoiturageSuisse')

from database.db_manager import get_db
from database.models import Booking, Trip, User

def clean_test_reservations():
    """Supprime toutes les rÃ©servations de test"""
    
    # Utiliser la VRAIE URL de production (celle du bot)
    # D'aprÃ¨s les logs: postgresql://covoiturage_qw9c_user:UT15TWaumLIVkmH...
    print("ğŸ” RÃ©cupÃ©ration de la vraie URL de base de donnÃ©es depuis les variables Render...")
    
    # On va utiliser la mÃªme mÃ©thode que le bot pour rÃ©cupÃ©rer DATABASE_URL
    from database.db_manager import get_db
    
    try:
        db = get_db()
        
        # Compter les rÃ©servations avant suppression
        total_bookings = db.query(Booking).count()
        print(f"ğŸ“Š Total rÃ©servations dans la vraie base: {total_bookings}")
        
        # Afficher les rÃ©servations de l'utilisateur ID 1 (vous)
        user_bookings = db.query(Booking).filter(Booking.passenger_id == 1).all()
        print(f"ğŸ“‹ Vos rÃ©servations (User ID 1): {len(user_bookings)}")
        
        # Afficher quelques rÃ©servations pour confirmation
        sample_bookings = db.query(Booking).limit(5).all()
        print(f"\nğŸ“‹ PremiÃ¨res rÃ©servations:")
        for booking in sample_bookings:
            trip = db.query(Trip).filter(Trip.id == booking.trip_id).first()
            if trip:
                print(f"  - ID {booking.id}: {trip.departure_city} â†’ {trip.arrival_city} le {trip.departure_time}")
        
        # Demander confirmation
        print(f"\nğŸ—‘ï¸  VOULEZ-VOUS SUPPRIMER TOUTES LES {total_bookings} RÃ‰SERVATIONS ?")
        response = input("Tapez 'OUI' en majuscules pour confirmer: ")
        
        if response == "OUI":
            # Supprimer toutes les rÃ©servations
            deleted_count = db.query(Booking).delete()
            db.commit()
            print(f"âœ… {deleted_count} rÃ©servations supprimÃ©es avec succÃ¨s!")
            
            # VÃ©rification
            remaining = db.query(Booking).count()
            print(f"ğŸ“Š RÃ©servations restantes: {remaining}")
            
        else:
            print("âŒ Suppression annulÃ©e")
            
    except Exception as e:
        print(f"âŒ Erreur: {e}")
        import traceback
        traceback.print_exc()
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    clean_test_reservations()
